@startuml LibraryAPI_ClassDiagram
' Title
skinparam backgroundColor #FFFFFF
skinparam classAttributeIconSize 0
skinparam ArrowColor #2F4858
skinparam ClassBorderColor #2F4858
skinparam ClassBackgroundColor #E8F1F5
skinparam NoteBackgroundColor #FFF7E6
skinparam NoteBorderColor #B07D00

package "Controllers" #DDFFDD {
  class BookController as "book_controller.py" {
    +get_all_books()
    +get_book_by_isbn(isbn)
    +search_books()
    +get_categories()
    +get_books_by_category(category)
    +get_book(id)
    +check_availability(id)
    +create_book(data)
    +update_book(id, data)
    +delete_book(id)
  }
  class LoanController as "loan_controller.py" {
    +get_all_loans(filters)
    +get_loan(id)
    +create_loan(data)
    +update_loan(id, data)
    +return_book(id)
    +delete_loan(id)
    +get_overdue_loans()
    +get_loans_by_borrower(name)
    +get_borrowed_loans()
  }
  class StatisticsController as "statistics_controller.py" {
    +get_statistics()
    +get_category_stats()
  }
}

package "Services (Facade)" #DDDDFF {
  class BookService {
    -repository: BookRepository
    -factory: ModelFactory
    -validator: BookValidationStrategy
    -event_subject: EventSubject
    +get_all_books(filters)
    +get_book_by_id(id)
    +search_books(keyword)
    +get_categories()
    +check_availability(id)
    +create_book(data)
    +update_book(id, data)
    +delete_book(id)
  }
  class LoanService {
    -loan_repository: LoanRepository
    -book_repository: BookRepository
    -factory: ModelFactory
    -validator: LoanValidationStrategy
    -event_subject: EventSubject
    +get_all_loans(filters)
    +get_loan_by_id(id)
    +create_loan(data)
    +return_book(id, return_date)
    +get_overdue_loans()
    +get_loans_by_borrower(name)
  }
  class StatisticsService {
    -book_repository: BookRepository
    -loan_repository: LoanRepository
    +get_library_statistics()
    +get_category_statistics()
  }
}

package "Repositories (Adapter)" #FFEEDD {
  interface BaseRepository {
    +find_all(filters)
    +find_by_id(id)
    +save(entity)
    +update(entity)
    +delete(id)
    +count(filters)
  }
  class BookRepository {
    +find_all(filters)
    +find_by_id(id)
    +find_by_isbn(isbn)
    +search(keyword)
    +get_categories()
    +save(book)
    +update(book)
    +delete(id)
    +hard_delete(id)
    +count(filters)
    +update_availability(book_id, delta)
  }
  class LoanRepository {
    +find_all(filters)
    +find_by_id(id)
    +save(loan)
    +update(loan)
    +delete(id)
    +count(filters)
    +find_active_by_book(book_id)
    +find_overdue_loans()
    +find_by_borrower(name)
    +get_loan_statistics()
  }
}

package "Validators (Strategy)" #FFF4F4 {
  interface ValidationStrategy {
    +validate(data)
    #_check_required_fields(data, fields)
    #_check_string_length(value, name, min, max)
  }
  class BookValidationStrategy {
    +REQUIRED_FIELDS_CREATE: List
    +MAX_TITLE_LENGTH: int
    +MAX_AUTHOR_LENGTH: int
    +MAX_ISBN_LENGTH: int
    +MAX_CATEGORY_LENGTH: int
    +MIN_YEAR: int
    +validate(data, is_update)
    -_validate_isbn(isbn, book_id)
    -_validate_year(year)
    -_validate_stock(stock)
  }
  class LoanValidationStrategy {
    +REQUIRED_FIELDS: List
    +MAX_BORROWER_NAME_LENGTH: int
    +MAX_LOAN_DAYS: int
    +validate(data)
    +validate_return(loan_id)
    -_validate_book(book_id)
    -_validate_date(date_str, field_name)
    -_validate_loan_duration(loan_date, due_date)
  }
}

package "Factory (Creational)" #F0FFF0 {
  class ModelFactory {
    +create_book(data)
    +create_loan(data)
    +update_book(book, data)
  }
}

package "Observers (Behavioral)" #F4F9FF {
  interface EventObserver {
    +update(event_type, data)
    +get_subscribed_events()
  }
  class EventSubject {
    -_observers: Dict
    +attach(observer)
    +detach(observer)
    +notify(event_type, data)
    +get_observer_count(event_type)
  }
  class ActivityLogger {
    -log_file: str
    -logger: Logger
    +update(event_type, data)
    +get_subscribed_events()
    +log_custom(message, level)
    -_setup_logger()
    -_format_message(event_type, data)
  }
  class EventType <<enumeration>> {
    BOOK_CREATED
    BOOK_UPDATED
    BOOK_DELETED
    LOAN_CREATED
    LOAN_RETURNED
    SYSTEM_ERROR
    SYSTEM_WARNING
  }
}

package "Database (Singleton)" #FFF0F5 {
  class DatabaseConnection {
    -_instance: DatabaseConnection
    -_lock: Lock
    -db: SQLAlchemy
    -_initialized: bool
    +__new__()
    +get_db()
    +init_app(app)
    +create_tables(app)
    +drop_tables(app)
  }
}

package "Models" #EEFFEE {
  class Book {
    -id: int
    -title: str
    -author: str
    -isbn: str
    -year: int
    -category: str
    -stock: int
    -available: int
    -created_at: datetime
    -updated_at: datetime
    -is_deleted: bool
    +__init__(title, author, isbn, year, category, stock)
    +to_dict()
    +__repr__()
  }
  class Loan {
    -id: int
    -book_id: int
    -borrower_name: str
    -loan_date: date
    -due_date: date
    -return_date: date
    -status: str
    -notes: text
    -created_at: datetime
    +__init__(book_id, borrower_name, loan_date, due_date, notes)
    +mark_as_returned(return_date)
    +is_overdue(): bool
    +to_dict()
    +__repr__()
  }
}

' Relationships
BookController --> BookService
LoanController --> LoanService
StatisticsController --> StatisticsService

BookService --> BookRepository
BookService --> ModelFactory
BookService --> BookValidationStrategy
BookService --> EventSubject

LoanService --> LoanRepository
LoanService --> ModelFactory
LoanService --> LoanValidationStrategy
LoanService --> EventSubject

BookRepository ..|> BaseRepository
LoanRepository ..|> BaseRepository

BookValidationStrategy ..|> ValidationStrategy
LoanValidationStrategy ..|> ValidationStrategy

ActivityLogger ..|> EventObserver

EventSubject o--> ActivityLogger : notifies
EventSubject ..> EventType : uses

Book "1" o-- "*" Loan : has

DatabaseConnection --> BookRepository : SQLAlchemy Session
DatabaseConnection --> LoanRepository : SQLAlchemy Session

' Notes
note right of Loan
status âˆˆ {borrowed, returned, overdue}
notes: optional
end note

note left of DatabaseConnection
Singleton: one SQLAlchemy instance
end note

@enduml